#!/bin/bash

VIRTUAL_ENV_NAME=$(basename "${VIRTUAL_ENV}")
VIRTUAL_ENV_SRC="${VIRTUAL_ENV}/src"
SUBLIME_TEXT_PROJECT_PATH="/Users/jefftriplett/Library/Application Support/Sublime Text 3/Packages/User/Projects"

if [ -d "${VIRTUAL_ENV_SRC}" ]; then
  cd "${VIRTUAL_ENV_SRC}" || exit
else
  mkdir -p "${VIRTUAL_ENV_SRC}"
  cd "${VIRTUAL_ENV_SRC}" || exit
  add2virtualenv .

  touch .envrc
  echo "export COMPOSE_DOCKER_CLI_BUILD=1" >> .envrc
  echo "export DOCKER_BUILDKIT=1" >> .envrc
  echo "export PIP_DISABLE_PIP_VERSION_CHECK=1" >> .envrc
  echo "export PYTHONDONTWRITEBYTECODE=1" >> .envrc
  echo "export PYTHONUNBUFFERED=1" >> .envrc

  if ! [ -e direnv ]; then
    direnv allow
  fi
fi

PROJECT_FILE="${SUBLIME_TEXT_PROJECT_PATH}/${VIRTUAL_ENV_NAME}.sublime-project"

echo "${PROJECT_FILE}"

CONTINUE=false

if ! [ -e "${PROJECT_FILE}" ]; then
  read -p "Would you like to create a new SublimeText project for this virtualenv? " -n 1 -r response
  echo

  if [[ $response =~ ^([yY][eE][sS]|[yY])$ ]]; then
    CONTINUE=true
  fi

  if $CONTINUE; then
    if ! [ -e jq ]; then
      echo "Creating ${PROJECT_FILE}"
      echo "{\"folders\": [{\"path\": \"${VIRTUAL_ENV_SRC}\"}]}" | jq > "${PROJECT_FILE}"
    fi
  fi
fi

# export GEM_HOME="$VIRTUAL_ENV/gems"
# export GEM_PATH=""
# export PATH=$PATH:$GEM_HOME/bin

# Set our user.badge back to our default
# export USER_BADGE="üêç"

# set our tab name
# npm install -g iterm2-tab-set
if ! [ -e tabset ]; then
  tabset --title "${VIRTUAL_ENV_NAME}"
fi

# TODO: Ansible go...
# go get github.com/arsham/figurine
if ! [ -e figurine ]; then
  figurine "${VIRTUAL_ENV_NAME}"
fi
